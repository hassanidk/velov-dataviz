<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style>
html, body{
  width:100%;
  height:100%;
  margin:0;
  padding:0;
}
#mapCanvas{
  float:left;
  width:80%;
  height:100%;
}

#mapSide{
  float:left;
  width:20%;
  height:100%;s
}

.stations, .stations svg {
  position: absolute;
}

.stations svg {
  width: 60px;
  height: 20px;
  padding-right: 100px;
  font: 10px sans-serif;
}

.stations circle {
  fill: brown;
  stroke: black;
  stroke-width: 1.5px;
}
</style>

<div id="mapCanvas"></div>
<div id="mapSide"></div>
<script src="//maps.google.com/maps/api/js?sensor=true"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=drawing"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
    // Create the Google Map…


    var map = new google.maps.Map(d3.select("#mapCanvas").node(), {
        zoom: 12,
        center: new google.maps.LatLng(48.117266, -1.677793),
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });
var allMarkers = []
var rectangle = null;
/*
 * use google maps api built-in mechanism to attach dom events
 */

    var projection = d3.geoAlbers();

    var path = d3.geoPath()
        .projection(projection);

    d3.json("rennes.json", function(json) {
        var boundaries = boundariesRennes(json.geometries[0].coordinates[0][0])
        var boundariesPath = new google.maps.Polyline({
            path: boundaries,
            geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
        });

        boundariesPath.setMap(map);


    });
  
  d3.json("https://data.rennesmetropole.fr/api/records/1.0/search/?rows=100&dataset=etat-des-stations-le-velo-star-en-temps-reel&facet=nom&facet=etat&facet=nombreemplacementsactuels&facet=nombreemplacementsdisponibles&facet=nombrevelosdisponibles", function(json){
  /* Methode D3 JS    
  var overlay = new google.maps.OverlayView();

  // Add the container when the overlay is added to the map.
  overlay.onAdd = function() {
    var layer = d3.select(this.getPanes().overlayLayer).append("div")
        .attr("class", "stations");

    // Draw each marker as a separate SVG element.
    // We could use a single SVG, but what size would it have?
    overlay.draw = function() {
      var projection = this.getProjection(),
          padding = 10;

      var marker = layer.selectAll("svg")
          .data(json.records)
          .each(transform) // update existing markers
        .enter().append("svg")
          .each(transform)
          .attr("class", "marker");
      // Add a circle.
      marker.append("circle")
          .attr("r", 7.5)
          .attr("cx", padding)
          .attr("cy", padding);
  
      // Add a label.
      marker.append("text")
          .attr("x", padding )
          .attr("y", padding)
          .attr("dy", ".31em")
          .text(function(d) { return d.fields.nom; });
      function transform(d) {
       
        d = new google.maps.LatLng(d.geometry.coordinates[1],d.geometry.coordinates[0]);
        d = projection.fromLatLngToDivPixel(d);
        return d3.select(this)
            .style("left", (d.x - padding ) + "px")
            .style("top", (d.y - padding) + "px");
      }
    };
  };*/
  // Bind our overlay to the map…
  //overlay.setMap(map);
// Methode Google MAP
  var records = json.records;
  for (var i = 0; i< records.length; i++){

    var myLatLng = {lat : records[i].geometry.coordinates[1] , lng: records[i].geometry.coordinates[0]};
    var marker = new google.maps.Marker({
      id : i,
      position : myLatLng,
      map : map,
      title : records[i].fields.nom
    });
    allMarkers.push(marker)
  }



});
google.maps.event.addDomListener(window, "load", function () {

    
    
    var drawingManager = new google.maps.drawing.DrawingManager({
        // drawingMode: google.maps.drawing.OverlayType.RECTANGLE,
        drawingControl : true,
        drawingControlOptions : {
            position : google.maps.ControlPosition.TOP_CENTER,
            drawingModes : [
            // google.maps.drawing.OverlayType.POLYGON,
            google.maps.drawing.OverlayType.RECTANGLE ]
        },
        rectangleOptions : {
            strokeWeight : 1,
            clickable : true,
            editable : false,
            zIndex : 1
        }
    });
    drawingManager.setMap(map);
    
    google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
        if (event.type == google.maps.drawing.OverlayType.RECTANGLE) {
            if(rectangle != null)
                rectangle.setMap(null);
            rectangle = event.overlay;
            var bounds = rectangle.getBounds();
            console.log(bounds);
            for (var i =0; i< allMarkers.length;i++){
              if (bounds.contains(allMarkers[i].getPosition())){
                // TODO ANTHONY FAINEANT
// Je t'aide un peu pour l'intégration, tu as le choix. Soit t'utilise l'id et appelle ta fonction pour chaque ID
// Soit tu cree une liste, puis tu fais passer ta liste dans ta fonction
// Je suis gentil ton intégration va se faire sans souci, j'ai aucun svg, par contre tu l'affecte à la div mapSide
// Enjoy (ET supprime ces commentaires après ;))
                console.log(allMarkers[i].id)
    
              }
            }
            drawingManager.setDrawingMode(null);
        }
    });
    
    google.maps.event.addListener(drawingManager, "drawingmode_changed", function() {
        if ((drawingManager.getDrawingMode() == google.maps.drawing.OverlayType.RECTANGLE) && 
            (rectangle != null))
            rectangle.setMap(null);
    });
    
    // when the user clicks somewhere else on the map.
    google.maps.event.addListener(map, 'click', function() {    
        if(rectangle != null)
            rectangle.setMap(null);
    });
});

 
console.log(allMarkers)



    function boundariesRennes(data) {
        var resultArray = [];
        for (var i = 0; i < data.length; i++) {
            resultArray.push({
                lat: data[i][1],
                lng: data[i][0]
            });
        }
        var coordsBoundaries = []
        for (var i = 0; i < resultArray.length; i++) {
            coordsBoundaries[i] = new google.maps.LatLng(resultArray[i].lat, resultArray[i].lng);
        }
        return coordsBoundaries;
    }
</script>